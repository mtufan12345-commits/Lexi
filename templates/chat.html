{% extends "base.html" %}

{% block content %}
<div class="flex flex-col h-screen bg-gray-100">
    {% if session.get('impersonating_from') == 'super_admin' %}
    <div class="bg-orange-600 text-white py-3 flex-shrink-0">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="font-semibold">üîê Super Admin Modus</span>
                    <span class="text-orange-200">Je bekijkt dit account als super administrator</span>
                </div>
                <form method="POST" action="{{ url_for('stop_impersonate') }}" class="inline">
                    <button type="submit" class="px-4 py-1 bg-white text-orange-600 rounded hover:bg-orange-100 font-medium">
                        Stop Impersonation
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    
<div class="flex flex-1 overflow-hidden">
    <div class="w-64 bg-white border-r border-gray-200 flex flex-col">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-xl font-bold text-indigo-600">LEX CAO Expert</h2>
            <p class="text-sm text-gray-600">{{ tenant.company_name }}</p>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4">
            <button onclick="newChat()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition mb-4">
                + Nieuwe Chat
            </button>
            
            <div id="chat-list" class="space-y-2">
                {% for chat in chats %}
                <div class="p-3 rounded-lg hover:bg-gray-100 border border-gray-200 chat-item relative group" 
                     data-chat-id="{{ chat.id }}">
                    <div onclick="loadChat({{ chat.id }})" class="cursor-pointer">
                        <div class="font-medium text-sm truncate pr-6">{{ chat.title }}</div>
                        <div class="text-xs text-gray-500">{{ chat.updated_at.strftime('%d-%m %H:%M') }}</div>
                    </div>
                    <button onclick="event.stopPropagation(); renameChatFromSidebar({{ chat.id }}, '{{ chat.title }}')" 
                            class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-indigo-600"
                            title="Naam wijzigen">
                        ‚úèÔ∏è
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200">
            <div class="text-sm text-gray-600 mb-2">{{ user.full_name }}</div>
            <a href="/profile" class="block text-sm text-indigo-600 hover:text-indigo-800 mb-2">
                üë§ Mijn Profiel
            </a>
            {% if user.role == 'admin' %}
            <a href="/admin/dashboard" class="block text-sm text-indigo-600 hover:text-indigo-800 mb-2">
                ‚öôÔ∏è Dashboard
            </a>
            {% endif %}
            <a href="/logout" class="block text-sm text-gray-600 hover:text-gray-800">
                Uitloggen
            </a>
        </div>
    </div>
    
    <div class="flex-1 flex flex-col">
        <div class="bg-white border-b border-gray-200 p-4 flex justify-between items-center">
            <h3 id="chat-title" class="text-lg font-semibold">Selecteer of start een chat</h3>
            <div id="chat-actions" class="hidden space-x-2">
                <button onclick="exportChat()" class="text-sm text-indigo-600 hover:text-indigo-800">
                    üì• Export
                </button>
                <button onclick="renameChat()" class="text-sm text-gray-600 hover:text-gray-800">
                    ‚úèÔ∏è Hernoemen
                </button>
                <button onclick="deleteChat()" class="text-sm text-red-600 hover:text-red-800">
                    üóëÔ∏è Verwijderen
                </button>
            </div>
        </div>
        
        <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-4">
            <div class="text-center text-gray-500 py-10">
                <div class="text-6xl mb-4">ü§ñ</div>
                <p class="text-xl">Welkom bij LEX!</p>
                <p class="text-sm mb-6">Stel me een vraag over CAO's en ik help je direct.</p>
                
                <div class="max-w-2xl mx-auto">
                    <p class="text-sm font-medium text-gray-700 mb-3">Voorbeeldvragen:</p>
                    <div class="grid md:grid-cols-2 gap-3">
                        <button onclick="askExampleQuestion('Wat zijn de minimumloonschalen voor uitzendbureaus in 2025?')" 
                                class="p-3 bg-white border border-indigo-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-400 transition text-left">
                            <div class="text-sm font-medium text-indigo-700">üí∞ Minimumloonschalen</div>
                            <div class="text-xs text-gray-600 mt-1">Wat zijn de minimumloonschalen voor uitzendbureaus in 2025?</div>
                        </button>
                        <button onclick="askExampleQuestion('Hoeveel vakantiedagen heeft een uitzendkracht recht op?')" 
                                class="p-3 bg-white border border-indigo-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-400 transition text-left">
                            <div class="text-sm font-medium text-indigo-700">üèñÔ∏è Vakantiedagen</div>
                            <div class="text-xs text-gray-600 mt-1">Hoeveel vakantiedagen heeft een uitzendkracht recht op?</div>
                        </button>
                        <button onclick="askExampleQuestion('Wat is de opzegtermijn voor een tijdelijk contract?')" 
                                class="p-3 bg-white border border-indigo-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-400 transition text-left">
                            <div class="text-sm font-medium text-indigo-700">üìã Opzegtermijn</div>
                            <div class="text-xs text-gray-600 mt-1">Wat is de opzegtermijn voor een tijdelijk contract?</div>
                        </button>
                        <button onclick="askExampleQuestion('Welke toeslagen gelden voor nacht- en weekendwerk?')" 
                                class="p-3 bg-white border border-indigo-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-400 transition text-left">
                            <div class="text-sm font-medium text-indigo-700">‚è∞ Toeslagen</div>
                            <div class="text-xs text-gray-600 mt-1">Welke toeslagen gelden voor nacht- en weekendwerk?</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="lex-animation-container" class="hidden relative h-64 bg-gradient-to-b from-indigo-50 to-white border-b border-indigo-100 overflow-hidden">
            <!-- Progress bar (alleen visueel, geen tekst) -->
            <div class="absolute top-4 left-1/2 transform -translate-x-1/2 w-64">
                <div class="w-full bg-gray-200 rounded-full h-1.5">
                    <div id="lex-progress" class="bg-indigo-600 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Grond lijn -->
            <div class="absolute bottom-16 left-0 right-0 h-0.5 bg-gray-400"></div>
            
            <!-- LEX - Ultra gedetailleerd poppetje uit honderden streepjes -->
            <svg id="lex-stickman" class="absolute transition-all duration-300" style="bottom: 60px; left: 10%; width: 100px; height: 120px;">
                <!-- Hoofd (vele concentrische cirkels) -->
                <g id="lex-head-group">
                    <circle cx="50" cy="20" r="15" fill="none" stroke="#4F46E5" stroke-width="2"/>
                    <circle cx="50" cy="20" r="14" fill="none" stroke="#4F46E5" stroke-width="0.3" opacity="0.7"/>
                    <circle cx="50" cy="20" r="13" fill="none" stroke="#4F46E5" stroke-width="0.3" opacity="0.6"/>
                    <circle cx="50" cy="20" r="12" fill="none" stroke="#4F46E5" stroke-width="0.3" opacity="0.5"/>
                    <circle cx="50" cy="20" r="11" fill="none" stroke="#4F46E5" stroke-width="0.3" opacity="0.4"/>
                    <circle cx="50" cy="20" r="10" fill="none" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                    <circle cx="50" cy="20" r="9" fill="none" stroke="#4F46E5" stroke-width="0.3" opacity="0.2"/>
                    <!-- Gezicht -->
                    <circle cx="44" cy="18" r="2.5" fill="#4F46E5"/>
                    <circle cx="56" cy="18" r="2.5" fill="#4F46E5"/>
                    <circle cx="44" cy="18" r="1.5" fill="none" stroke="#4F46E5" stroke-width="0.5"/>
                    <circle cx="56" cy="18" r="1.5" fill="none" stroke="#4F46E5" stroke-width="0.5"/>
                    <path d="M 44 25 Q 50 28 56 25" fill="none" stroke="#4F46E5" stroke-width="2"/>
                    <path d="M 44 25 Q 50 27 56 25" fill="none" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                </g>
                
                <!-- Lichaam (vele parallelle lijnen) -->
                <g id="lex-body-group">
                    <line x1="50" y1="35" x2="50" y2="70" stroke="#4F46E5" stroke-width="3"/>
                    <line x1="48" y1="35" x2="48" y2="70" stroke="#4F46E5" stroke-width="0.5" opacity="0.6"/>
                    <line x1="49" y1="35" x2="49" y2="70" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                    <line x1="51" y1="35" x2="51" y2="70" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                    <line x1="52" y1="35" x2="52" y2="70" stroke="#4F46E5" stroke-width="0.5" opacity="0.6"/>
                    <line x1="47" y1="35" x2="47" y2="70" stroke="#4F46E5" stroke-width="0.3" opacity="0.4"/>
                    <line x1="53" y1="35" x2="53" y2="70" stroke="#4F46E5" stroke-width="0.3" opacity="0.4"/>
                    <line x1="46" y1="35" x2="46" y2="70" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                    <line x1="54" y1="35" x2="54" y2="70" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                </g>
                
                <!-- Linker arm (vele lijnen) -->
                <g id="lex-arm-left-group">
                    <line id="lex-arm-left" x1="50" y1="45" x2="25" y2="60" stroke="#4F46E5" stroke-width="3"/>
                    <line x1="50" y1="45" x2="26" y2="61" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                    <line x1="50" y1="45" x2="24" y2="59" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                    <line x1="50" y1="46" x2="25" y2="61" stroke="#4F46E5" stroke-width="0.4" opacity="0.4"/>
                    <line x1="50" y1="44" x2="25" y2="59" stroke="#4F46E5" stroke-width="0.4" opacity="0.4"/>
                    <line x1="50" y1="47" x2="25" y2="62" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                    <line x1="50" y1="43" x2="25" y2="58" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                </g>
                
                <!-- Rechter arm (vele lijnen) -->
                <g id="lex-arm-right-group">
                    <line id="lex-arm-right" x1="50" y1="45" x2="75" y2="60" stroke="#4F46E5" stroke-width="3"/>
                    <line x1="50" y1="45" x2="74" y2="61" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                    <line x1="50" y1="45" x2="76" y2="59" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                    <line x1="50" y1="46" x2="75" y2="61" stroke="#4F46E5" stroke-width="0.4" opacity="0.4"/>
                    <line x1="50" y1="44" x2="75" y2="59" stroke="#4F46E5" stroke-width="0.4" opacity="0.4"/>
                    <line x1="50" y1="47" x2="75" y2="62" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                    <line x1="50" y1="43" x2="75" y2="58" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                </g>
                
                <!-- Linker been (vele lijnen) -->
                <g id="lex-leg-left-group">
                    <line id="lex-leg-left" x1="50" y1="70" x2="35" y2="100" stroke="#4F46E5" stroke-width="3"/>
                    <line x1="50" y1="70" x2="36" y2="101" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                    <line x1="50" y1="70" x2="34" y2="99" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                    <line x1="50" y1="71" x2="35" y2="101" stroke="#4F46E5" stroke-width="0.4" opacity="0.4"/>
                    <line x1="50" y1="69" x2="35" y2="99" stroke="#4F46E5" stroke-width="0.4" opacity="0.4"/>
                    <line x1="50" y1="72" x2="35" y2="102" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                    <line x1="50" y1="68" x2="35" y2="98" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                </g>
                
                <!-- Rechter been (vele lijnen) -->
                <g id="lex-leg-right-group">
                    <line id="lex-leg-right" x1="50" y1="70" x2="65" y2="100" stroke="#4F46E5" stroke-width="3"/>
                    <line x1="50" y1="70" x2="64" y2="101" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                    <line x1="50" y1="70" x2="66" y2="99" stroke="#4F46E5" stroke-width="0.5" opacity="0.5"/>
                    <line x1="50" y1="71" x2="65" y2="101" stroke="#4F46E5" stroke-width="0.4" opacity="0.4"/>
                    <line x1="50" y1="69" x2="65" y2="99" stroke="#4F46E5" stroke-width="0.4" opacity="0.4"/>
                    <line x1="50" y1="72" x2="65" y2="102" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                    <line x1="50" y1="68" x2="65" y2="98" stroke="#4F46E5" stroke-width="0.3" opacity="0.3"/>
                </g>
            </svg>
            
            <!-- Vallende onderdelen container -->
            <div id="falling-parts-container" class="absolute inset-0 pointer-events-none"></div>
        </div>
        
        <style>
            @keyframes fall-and-spin {
                0% {
                    transform: translate(0, 0) rotate(0deg);
                    opacity: 1;
                }
                100% {
                    transform: translate(var(--fall-x, 0), 80px) rotate(720deg);
                    opacity: 0;
                }
            }
        </style>
        
        <div class="bg-white border-t border-gray-200 p-4">
            <form id="message-form" class="max-w-3xl mx-auto flex space-x-2">
                <input type="file" id="file-input" class="hidden" onchange="handleFileUpload(event)">
                <button type="button" onclick="document.getElementById('file-input').click()" 
                        class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    üìé
                </button>
                <input type="text" id="message-input" placeholder="Stel een vraag over CAO's..." 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Verstuur
                </button>
            </form>
        </div>
    </div>
</div>
</div>

<script>
let currentChatId = null;

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

function fetchWithCSRF(url, options = {}) {
    options.headers = options.headers || {};
    options.headers['X-CSRFToken'] = getCSRFToken();
    return fetch(url, options);
}

async function askExampleQuestion(question) {
    if (!currentChatId) {
        const response = await fetchWithCSRF('/api/chat/new', { method: 'POST' });
        const data = await response.json();
        currentChatId = data.id;
    }
    
    document.getElementById('message-input').value = question;
    document.getElementById('message-form').dispatchEvent(new Event('submit'));
}

function animateLimbs(isRunning) {
    const armLeft = document.getElementById('lex-arm-left');
    const armRight = document.getElementById('lex-arm-right');
    const legLeft = document.getElementById('lex-leg-left');
    const legRight = document.getElementById('lex-leg-right');
    
    if (!isRunning) {
        armLeft?.setAttribute('x2', '25');
        armLeft?.setAttribute('y2', '60');
        armRight?.setAttribute('x2', '75');
        armRight?.setAttribute('y2', '60');
        legLeft?.setAttribute('x2', '35');
        legLeft?.setAttribute('y2', '100');
        legRight?.setAttribute('x2', '65');
        legRight?.setAttribute('y2', '100');
        return;
    }
    
    let frame = 0;
    return setInterval(() => {
        frame++;
        const swing = Math.sin(frame * 0.3) * 20;
        
        armLeft?.setAttribute('x2', String(25 + swing));
        armLeft?.setAttribute('y2', String(60 - Math.abs(swing) * 0.5));
        armRight?.setAttribute('x2', String(75 - swing));
        armRight?.setAttribute('y2', String(60 - Math.abs(swing) * 0.5));
        
        legLeft?.setAttribute('x2', String(35 - swing));
        legLeft?.setAttribute('y2', String(100 - Math.abs(swing) * 0.3));
        legRight?.setAttribute('x2', String(65 + swing));
        legRight?.setAttribute('y2', String(100 - Math.abs(swing) * 0.3));
    }, 50);
}

function explodeIntoPieces() {
    const stickman = document.getElementById('lex-stickman');
    const container = document.getElementById('falling-parts-container');
    const groups = ['head', 'arm-left', 'arm-right', 'leg-left', 'leg-right'];
    
    container.innerHTML = '';
    
    groups.forEach((groupName, i) => {
        const group = document.getElementById(`lex-${groupName}-group`);
        if (!group) return;
        
        const clone = group.cloneNode(true);
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', '100');
        svg.setAttribute('height', '120');
        svg.style.position = 'absolute';
        svg.style.left = stickman.style.left;
        svg.style.bottom = stickman.style.bottom;
        svg.style.width = '100px';
        svg.style.height = '120px';
        svg.appendChild(clone);
        
        const fallX = (Math.random() - 0.5) * 100;
        svg.style.setProperty('--fall-x', fallX + 'px');
        svg.style.animation = `fall-and-spin 1.5s ease-out ${i * 0.15}s forwards`;
        
        container.appendChild(svg);
        group.style.opacity = '0';
    });
}

function reassemble() {
    const groups = ['head', 'arm-left', 'arm-right', 'leg-left', 'leg-right'];
    const container = document.getElementById('falling-parts-container');
    
    container.innerHTML = '';
    
    groups.forEach(groupName => {
        const group = document.getElementById(`lex-${groupName}-group`);
        if (group) group.style.opacity = '1';
    });
}

const LEX_SCENARIOS = [
    {
        name: 'crazy_jump_spin',
        action: (stickman) => {
            const limbInterval = animateLimbs(true);
            stickman.style.left = '5%';
            setTimeout(() => stickman.style.left = '30%', 100);
            setTimeout(() => {
                clearInterval(limbInterval);
                stickman.style.bottom = '100px';
                stickman.style.transform = 'rotate(360deg)';
            }, 1200);
            setTimeout(() => {
                stickman.style.bottom = '60px';
                stickman.style.transform = 'rotate(720deg)';
            }, 1800);
            setTimeout(() => {
                explodeIntoPieces();
                stickman.style.transform = 'rotate(0deg)';
            }, 2200);
            setTimeout(() => {
                reassemble();
                animateLimbs(false);
            }, 3800);
        }
    },
    {
        name: 'zigzag_run',
        action: (stickman) => {
            const limbInterval = animateLimbs(true);
            let pos = 5;
            let height = 60;
            let zigzags = 0;
            const zigzagInterval = setInterval(() => {
                pos += 10;
                height = zigzags % 2 === 0 ? 80 : 60;
                stickman.style.left = pos + '%';
                stickman.style.bottom = height + 'px';
                zigzags++;
                if (zigzags > 7) {
                    clearInterval(zigzagInterval);
                    clearInterval(limbInterval);
                    stickman.style.bottom = '60px';
                    animateLimbs(false);
                }
            }, 300);
        }
    },
    {
        name: 'backflip_explode',
        action: (stickman) => {
            const limbInterval = animateLimbs(true);
            stickman.style.left = '10%';
            setTimeout(() => stickman.style.left = '35%', 100);
            setTimeout(() => {
                clearInterval(limbInterval);
                stickman.style.bottom = '120px';
                stickman.style.transform = 'rotate(180deg)';
            }, 1500);
            setTimeout(() => {
                stickman.style.bottom = '90px';
                stickman.style.transform = 'rotate(270deg)';
            }, 1900);
            setTimeout(() => {
                stickman.style.bottom = '60px';
                stickman.style.transform = 'rotate(360deg)';
            }, 2300);
            setTimeout(() => {
                explodeIntoPieces();
                stickman.style.transform = 'rotate(0deg)';
            }, 2600);
            setTimeout(() => {
                reassemble();
                animateLimbs(false);
            }, 4200);
        }
    },
    {
        name: 'moonwalk_dance',
        action: (stickman) => {
            const limbInterval = animateLimbs(true);
            stickman.style.left = '60%';
            stickman.style.transform = 'scaleX(-1)';
            let pos = 60;
            const moonwalkInterval = setInterval(() => {
                pos -= 8;
                stickman.style.left = pos + '%';
                if (pos < 15) {
                    clearInterval(moonwalkInterval);
                    clearInterval(limbInterval);
                    stickman.style.transform = 'scaleX(1)';
                    stickman.style.bottom = '70px';
                    setTimeout(() => {
                        stickman.style.bottom = '60px';
                    }, 200);
                    setTimeout(() => {
                        stickman.style.bottom = '70px';
                    }, 400);
                    setTimeout(() => {
                        stickman.style.bottom = '60px';
                        animateLimbs(false);
                    }, 600);
                }
            }, 200);
        }
    },
    {
        name: 'speed_dash_crash',
        action: (stickman) => {
            const limbInterval = animateLimbs(true);
            stickman.style.left = '3%';
            stickman.style.transition = 'left 0.6s cubic-bezier(0, 0.5, 0.5, 1)';
            setTimeout(() => stickman.style.left = '80%', 100);
            setTimeout(() => {
                clearInterval(limbInterval);
                stickman.style.transform = 'rotate(180deg) scaleY(-1)';
            }, 700);
            setTimeout(() => {
                explodeIntoPieces();
                stickman.style.transform = 'rotate(0deg)';
                stickman.style.transition = 'left 0.3s';
            }, 1000);
            setTimeout(() => {
                reassemble();
                stickman.style.left = '40%';
                animateLimbs(false);
            }, 2800);
        }
    },
    {
        name: 'confused_spin',
        action: (stickman) => {
            let spins = 0;
            const spinInterval = setInterval(() => {
                stickman.style.transform = `rotate(${spins * 120}deg)`;
                spins++;
                if (spins > 5) {
                    clearInterval(spinInterval);
                    stickman.style.transform = 'rotate(0deg) scaleX(-1)';
                    setTimeout(() => {
                        stickman.style.transform = 'rotate(0deg) scaleX(1)';
                    }, 300);
                }
            }, 250);
        }
    },
    {
        name: 'triple_bounce',
        action: (stickman) => {
            const limbInterval = animateLimbs(true);
            stickman.style.left = '10%';
            setTimeout(() => stickman.style.left = '25%', 100);
            setTimeout(() => {
                stickman.style.bottom = '110px';
            }, 1000);
            setTimeout(() => {
                stickman.style.bottom = '60px';
                stickman.style.left = '40%';
            }, 1400);
            setTimeout(() => {
                stickman.style.bottom = '100px';
            }, 1800);
            setTimeout(() => {
                stickman.style.bottom = '60px';
                stickman.style.left = '55%';
            }, 2200);
            setTimeout(() => {
                stickman.style.bottom = '90px';
            }, 2600);
            setTimeout(() => {
                stickman.style.bottom = '60px';
                clearInterval(limbInterval);
                animateLimbs(false);
            }, 3000);
        }
    },
    {
        name: 'wall_bonk',
        action: (stickman) => {
            const limbInterval = animateLimbs(true);
            stickman.style.left = '10%';
            stickman.style.transition = 'left 1.2s linear';
            setTimeout(() => stickman.style.left = '85%', 100);
            setTimeout(() => {
                clearInterval(limbInterval);
                stickman.style.transform = 'scaleX(-1)';
            }, 1300);
            setTimeout(() => {
                explodeIntoPieces();
                stickman.style.transform = 'scaleX(1)';
                stickman.style.transition = 'left 0.3s';
            }, 1500);
            setTimeout(() => {
                reassemble();
                stickman.style.left = '40%';
                animateLimbs(false);
            }, 3300);
        }
    }
];

function startLexAnimation() {
    const container = document.getElementById('lex-animation-container');
    const stickman = document.getElementById('lex-stickman');
    const progressBar = document.getElementById('lex-progress');
    
    container.classList.remove('hidden');
    reassemble();
    stickman.style.left = '10%';
    stickman.style.bottom = '60px';
    stickman.style.transform = 'scaleX(1) rotate(0deg)';
    stickman.style.transition = 'left 0.3s, bottom 0.3s, transform 0.3s';
    
    let startTime = Date.now();
    let currentScenario = Math.floor(Math.random() * LEX_SCENARIOS.length);
    
    const runScenario = () => {
        const scenario = LEX_SCENARIOS[currentScenario % LEX_SCENARIOS.length];
        scenario.action(stickman);
        currentScenario++;
    };
    
    runScenario();
    const scenarioInterval = setInterval(runScenario, 4500);
    
    const progressInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min((elapsed / 30000) * 100, 95);
        progressBar.style.width = `${progress}%`;
    }, 500);
    
    return { progressInterval, scenarioInterval };
}

function stopLexAnimation(intervals) {
    clearInterval(intervals.progressInterval);
    clearInterval(intervals.scenarioInterval);
    
    const container = document.getElementById('lex-animation-container');
    const stickman = document.getElementById('lex-stickman');
    const progressBar = document.getElementById('lex-progress');
    
    reassemble();
    animateLimbs(false);
    stickman.style.left = '50%';
    stickman.style.bottom = '60px';
    stickman.style.transform = 'scaleX(1) rotate(0deg)';
    progressBar.style.width = '100%';
    
    setTimeout(() => {
        container.classList.add('hidden');
    }, 2000);
}

async function newChat() {
    const response = await fetchWithCSRF('/api/chat/new', { method: 'POST' });
    const data = await response.json();
    currentChatId = data.id;
    
    document.getElementById('messages-container').innerHTML = `
        <div class="text-center text-gray-500 py-20">
            <div class="text-6xl mb-4">ü§ñ</div>
            <p class="text-xl">Nieuwe chat gestart!</p>
            <p class="text-sm">Stel me een vraag over CAO's.</p>
        </div>
    `;
    
    document.getElementById('chat-title').textContent = data.title;
    document.getElementById('chat-actions').classList.remove('hidden');
    
    const chatList = document.getElementById('chat-list');
    const newChatItem = document.createElement('div');
    newChatItem.className = 'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border border-gray-200 chat-item bg-indigo-50 border-indigo-300';
    newChatItem.setAttribute('data-chat-id', data.id);
    newChatItem.onclick = () => loadChat(data.id);
    
    const now = new Date();
    const timeStr = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    newChatItem.innerHTML = `
        <div class="font-medium text-sm truncate">${data.title}</div>
        <div class="text-xs text-gray-500">${timeStr}</div>
    `;
    
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('bg-indigo-50', 'border-indigo-300');
    });
    
    chatList.insertBefore(newChatItem, chatList.firstChild);
}

async function loadChat(chatId) {
    currentChatId = chatId;
    
    const response = await fetch(`/api/chat/${chatId}`);
    const data = await response.json();
    
    document.getElementById('chat-title').textContent = data.title;
    document.getElementById('chat-actions').classList.remove('hidden');
    
    const container = document.getElementById('messages-container');
    container.innerHTML = '';
    
    data.messages.forEach(msg => {
        addMessageToUI(msg.role, msg.content, msg.artifacts || [], msg.id, msg.feedback_rating);
    });
    
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('bg-indigo-50', 'border-indigo-300');
    });
    document.querySelector(`[data-chat-id="${chatId}"]`)?.classList.add('bg-indigo-50', 'border-indigo-300');
}

function addMessageToUI(role, content, artifacts = [], messageId = null, feedbackRating = null) {
    const container = document.getElementById('messages-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
    messageDiv.setAttribute('data-message-id', messageId);
    
    let artifactsHtml = '';
    if (artifacts && artifacts.length > 0) {
        artifactsHtml = '<div class="mt-3 space-y-2 border-t pt-3">';
        artifacts.forEach(artifact => {
            artifactsHtml += `
                <button onclick="downloadArtifact(${artifact.id})" 
                    class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors w-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>Download: ${artifact.title}</span>
                </button>
            `;
        });
        artifactsHtml += '</div>';
    }
    
    let feedbackHtml = '';
    if (role === 'assistant' && messageId) {
        const disabled = feedbackRating ? 'opacity-50 pointer-events-none' : '';
        feedbackHtml = `
            <div class="mt-2 pt-2 border-t flex gap-2 items-center">
                <span class="text-xs text-gray-500">Hoe nuttig was dit antwoord?</span>
                <button onclick="submitFeedback(${messageId}, 1)" class="feedback-btn ${disabled} text-gray-400 hover:text-green-600 transition">
                    üëç
                </button>
                <button onclick="submitFeedback(${messageId}, -1)" class="feedback-btn ${disabled} text-gray-400 hover:text-red-600 transition">
                    üëé
                </button>
            </div>
        `;
    }
    
    messageDiv.innerHTML = `
        <div class="max-w-2xl ${role === 'user' ? 'bg-indigo-600 text-white' : 'bg-white border border-gray-200'} rounded-lg p-4">
            <div class="font-semibold text-sm mb-1">${role === 'user' ? 'Jij' : 'LEX ü§ñ'}</div>
            <div class="whitespace-pre-wrap">${content}</div>
            ${artifactsHtml}
            ${feedbackHtml}
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

document.getElementById('message-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    let isNewChat = false;
    let newChatId = null;
    
    if (!currentChatId) {
        const response = await fetchWithCSRF('/api/chat/new', { method: 'POST' });
        const data = await response.json();
        currentChatId = data.id;
        newChatId = data.id;
        isNewChat = true;
        document.getElementById('chat-actions').classList.remove('hidden');
    }
    
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    addMessageToUI('user', message);
    input.value = '';
    
    const animationInterval = startLexAnimation();
    
    try {
        const response = await fetchWithCSRF(`/api/chat/${currentChatId}/message`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
        
        const data = await response.json();
        stopLexAnimation(animationInterval);
        addMessageToUI('assistant', data.response, data.artifacts || [], data.message_id, data.feedback_rating);
        
        if (isNewChat && newChatId) {
            const newTitle = message.substring(0, 50) + (message.length > 50 ? '...' : '');
            document.getElementById('chat-title').textContent = newTitle;
            
            const chatList = document.getElementById('chat-list');
            const newChatItem = document.createElement('div');
            newChatItem.className = 'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border border-gray-200 chat-item bg-indigo-50 border-indigo-300';
            newChatItem.setAttribute('data-chat-id', newChatId);
            newChatItem.onclick = () => loadChat(newChatId);
            
            const now = new Date();
            const timeStr = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            newChatItem.innerHTML = `
                <div class="font-medium text-sm truncate">${newTitle}</div>
                <div class="text-xs text-gray-500">${timeStr}</div>
            `;
            
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('bg-indigo-50', 'border-indigo-300');
            });
            
            chatList.insertBefore(newChatItem, chatList.firstChild);
        }
    } catch (error) {
        stopLexAnimation(animationInterval);
        addMessageToUI('assistant', 'Er ging iets mis. Probeer het opnieuw.');
    }
});

async function renameChat() {
    if (!currentChatId) return;
    
    const newTitle = prompt('Nieuwe naam:');
    if (newTitle && newTitle.trim()) {
        const response = await fetchWithCSRF(`/api/chat/${currentChatId}/rename`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle.trim() })
        });
        
        if (response.ok) {
            document.getElementById('chat-title').textContent = newTitle.trim();
            const chatItem = document.querySelector(`[data-chat-id="${currentChatId}"]`);
            if (chatItem) {
                chatItem.querySelector('.font-medium').textContent = newTitle.trim();
            }
        }
    }
}

async function renameChatFromSidebar(chatId, currentTitle) {
    const newTitle = prompt('Nieuwe naam:', currentTitle);
    if (newTitle && newTitle.trim() && newTitle.trim() !== currentTitle) {
        const response = await fetchWithCSRF(`/api/chat/${chatId}/rename`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle.trim() })
        });
        
        if (response.ok) {
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (chatItem) {
                chatItem.querySelector('.font-medium').textContent = newTitle.trim();
            }
            
            if (currentChatId === chatId) {
                document.getElementById('chat-title').textContent = newTitle.trim();
            }
        }
    }
}

async function deleteChat() {
    if (!currentChatId) return;
    
    if (confirm('Weet je zeker dat je deze chat wilt verwijderen?')) {
        await fetchWithCSRF(`/api/chat/${currentChatId}/delete`, { method: 'DELETE' });
        
        const chatItem = document.querySelector(`[data-chat-id="${currentChatId}"]`);
        if (chatItem) {
            chatItem.remove();
        }
        
        currentChatId = null;
        document.getElementById('messages-container').innerHTML = `
            <div class="text-center text-gray-500 py-20">
                <div class="text-6xl mb-4">ü§ñ</div>
                <p class="text-xl">Chat verwijderd</p>
                <p class="text-sm">Start een nieuwe chat of selecteer een bestaande.</p>
            </div>
        `;
        document.getElementById('chat-title').textContent = 'Selecteer of start een chat';
        document.getElementById('chat-actions').classList.add('hidden');
    }
}

function exportChat() {
    if (!currentChatId) return;
    window.location.href = `/api/chat/${currentChatId}/export`;
}

async function submitFeedback(messageId, rating) {
    const comment = prompt('Optionele opmerking over dit antwoord:');
    
    await fetchWithCSRF('/api/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            message_id: messageId,
            rating: rating,
            comment: comment || ''
        })
    });
    
    const feedbackBtns = document.querySelectorAll(`[data-message-id="${messageId}"] .feedback-btn`);
    feedbackBtns.forEach(btn => btn.classList.add('opacity-50', 'pointer-events-none'));
    
    alert('Bedankt voor je feedback!');
}

async function handleFileUpload(event) {
    if (!currentChatId) {
        const response = await fetchWithCSRF('/api/chat/new', { method: 'POST' });
        const data = await response.json();
        currentChatId = data.id;
    }
    
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('chat_id', currentChatId);
    
    try {
        const response = await fetchWithCSRF('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            alert('Bestand ge√ºpload! Je kunt nu vragen stellen over dit document.');
        }
    } catch (error) {
        alert('Upload mislukt. Probeer het opnieuw.');
    }
}

async function downloadArtifact(artifactId) {
    try {
        const response = await fetch(`/api/artifact/${artifactId}/download`);
        const data = await response.json();
        
        if (data.download_url) {
            const link = document.createElement('a');
            link.href = data.download_url;
            link.download = data.title;
            link.click();
        } else {
            alert('Download niet beschikbaar');
        }
    } catch (error) {
        alert('Download mislukt');
    }
}
</script>
{% endblock %}
