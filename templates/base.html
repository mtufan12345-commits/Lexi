<!DOCTYPE html>
<html lang="nl" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon.png') }}">
    
    <!-- SEO Meta Tags -->
    <title>{% block title %}Lexi CAO Meester - AI-assistent voor CAO-vragen{% endblock %}</title>
    <meta name="description" content="{% block description %}AI-assistent voor CAO-vragen in de glastuinbouw. Van CAO-regels tot arbeidsrecht, van loonberekening tot internationale detacheringsregels. Bespaar €18.000/jaar aan advieskosten.{% endblock %}">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{% block canonical %}https://lexiai.nl{{ request.path }}{% endblock %}">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="{% block og_title %}Lexi CAO Meester - AI-assistent voor CAO-vragen{% endblock %}">
    <meta property="og:description" content="{% block og_description %}1.000+ juridische documenten, 24/7 beschikbaar. Gemiddeld €18.000/jaar kostenbesparing.{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{% block og_url %}https://lexiai.nl{{ request.path }}{% endblock %}">
    <meta property="og:image" content="{% block og_image %}https://lexiai.nl/static/images/lexi-logo.png{% endblock %}">
    <meta property="og:site_name" content="Lexi AI">
    <meta property="og:locale" content="nl_NL">
    
    <!-- Twitter Card Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}Lexi CAO Meester - AI-assistent voor CAO-vragen{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}AI-assistent voor CAO-vragen in de glastuinbouw. 1.000+ juridische documenten, 24/7 beschikbaar. Bespaar €18.000/jaar.{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}https://lexiai.nl/static/images/lexi-logo.png{% endblock %}">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}?v={{ build_version }}">
    <style>
        .lexi-animation {
            font-family: monospace;
            font-size: 2rem;
            white-space: pre;
            text-align: center;
            line-height: 1.2;
        }
        .chat-message {
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page-fade {
            transition: opacity 0.15s ease-in-out;
        }
        .page-fade.hiding {
            opacity: 0;
        }
        
        /* Custom scrollbar for light mode */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        
        /* Custom scrollbar for dark mode */
        .dark ::-webkit-scrollbar-track {
            background: #18181b;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 5px;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }
        
        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f1f1f1;
        }
        .dark * {
            scrollbar-color: #3f3f46 #18181b;
        }
    </style>
    <script>
        if (localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50 dark:bg-black transition-colors duration-200 h-full">
    <div id="page-content" class="page-fade h-full">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="fixed top-4 right-4 z-50 space-y-2">
                {% for category, message in messages %}
                <div class="bg-{% if category == 'success' %}green{% elif category == 'danger' %}red{% else %}blue{% endif %}-100 border border-{% if category == 'success' %}green{% elif category == 'danger' %}red{% else %}blue{% endif %}-400 text-{% if category == 'success' %}green{% elif category == 'danger' %}red{% else %}blue{% endif %}-700 px-4 py-3 rounded relative" role="alert">
                    <span class="block sm:inline">{{ message }}</span>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    {% block content %}{% endblock %}
    </div>
    
    <script>
        // SPA-like navigation without page reloads
        function navigateTo(url) {
            const content = document.getElementById('page-content');
            
            // Fade out
            content.classList.add('hiding');
            
            setTimeout(() => {
                // Fetch new content
                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    // Parse HTML and extract content
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newContent = doc.getElementById('page-content');
                    
                    if (newContent) {
                        // Extract and save scripts before updating content
                        const scripts = Array.from(newContent.querySelectorAll('script'));
                        const scriptContents = scripts.map(script => script.textContent);

                        // Update content
                        content.innerHTML = newContent.innerHTML;

                        // Update title
                        const newTitle = doc.querySelector('title');
                        if (newTitle) {
                            document.title = newTitle.textContent;
                        }

                        // Update URL
                        window.history.pushState({}, '', url);

                        // Re-execute scripts (they don't auto-execute via innerHTML)
                        scriptContents.forEach(scriptText => {
                            if (scriptText.trim()) {
                                try {
                                    // Use Function constructor instead of eval for better scoping
                                    const fn = new Function(scriptText);
                                    fn();
                                } catch (error) {
                                    console.error('Script execution error:', error);
                                }
                            }
                        });

                        // Fade in
                        content.classList.remove('hiding');

                        // Reinitialize nav links
                        initNavLinks();
                    }
                })
                .catch(error => {
                    console.error('Navigation error:', error);
                    window.location.href = url; // Fallback to regular navigation
                });
            }, 150);
        }
        
        function initNavLinks() {
            document.querySelectorAll('a[href^="/"]').forEach(link => {
                // Skip external links, hash links, and already processed links
                if (link.hasAttribute('data-spa-nav') || 
                    link.getAttribute('href').startsWith('#') ||
                    link.getAttribute('target') === '_blank') {
                    return;
                }
                
                link.setAttribute('data-spa-nav', 'true');
                link.addEventListener('click', (e) => {
                    const href = link.getAttribute('href');
                    
                    // Don't intercept form submits, logout, or special routes
                    if (href.includes('/logout') || 
                        href.includes('/api/') ||
                        href.includes('/chat') ||
                        href.includes('/admin') ||
                        href.includes('/super-admin')) {
                        return; // Let it navigate normally
                    }
                    
                    e.preventDefault();
                    navigateTo(href);
                });
            });
        }
        
        // Handle browser back/forward
        window.addEventListener('popstate', () => {
            navigateTo(window.location.pathname);
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initNavLinks);
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
