<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket #{{ ticket.ticket_number }} - Super Admin</title>
    <link href="/static/css/output.css" rel="stylesheet">
    <script>
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-black min-h-screen">
    <div class="max-w-6xl mx-auto p-8">
        <!-- Header -->
        <div class="mb-6">
            <a href="/super-admin/support" class="inline-flex items-center text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white mb-4">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Terug naar tickets
            </a>
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Ticket #{{ ticket.ticket_number }}</h1>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">{{ ticket.subject }}</p>
                </div>
                <select id="statusDropdown" class="px-4 py-2 border border-gray-300 dark:border-zinc-700 rounded-lg bg-white dark:bg-zinc-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                    <option value="open" {{ 'selected' if ticket.status == 'open' }}>ðŸ”´ Open</option>
                    <option value="in_progress" {{ 'selected' if ticket.status == 'in_progress' }}>ðŸŸ¡ In behandeling</option>
                    <option value="answered" {{ 'selected' if ticket.status == 'answered' }}>ðŸŸ¡ Beantwoord</option>
                    <option value="closed" {{ 'selected' if ticket.status == 'closed' }}>ðŸŸ¢ Gesloten</option>
                </select>
            </div>
        </div>

        <!-- Ticket Info -->
        <div class="bg-white dark:bg-zinc-900 rounded-lg border border-gray-200 dark:border-zinc-800 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Klant</p>
                    <p class="text-gray-900 dark:text-white font-medium mt-1">{{ tenant.company_name if tenant }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Gebruiker</p>
                    <p class="text-gray-900 dark:text-white font-medium mt-1">{{ user.name if user }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Categorie</p>
                    <p class="text-gray-900 dark:text-white font-medium mt-1">
                        {% if ticket.category == 'technical' %}Technisch
                        {% elif ticket.category == 'lex_question' %}Lexi Vraag
                        {% elif ticket.category == 'billing' %}Facturering
                        {% elif ticket.category == 'cao_related' %}CAO-gerelateerd
                        {% else %}Overig{% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="bg-white dark:bg-zinc-900 rounded-lg border border-gray-200 dark:border-zinc-800 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Conversatie</h2>
            
            <div id="messages" class="space-y-4 mb-6 max-h-96 overflow-y-auto">
                <!-- Initial message -->
                <div class="flex gap-3">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-zinc-700 flex items-center justify-center text-gray-600 dark:text-gray-300 font-medium">
                            {{ ticket.user_name[0] if ticket.user_name }}
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="bg-gray-100 dark:bg-zinc-800 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ ticket.user_name }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">{{ ticket.created_at.strftime('%d-%m-%Y %H:%M') }}</p>
                            </div>
                            <p class="text-gray-700 dark:text-gray-300">{{ ticket.description }}</p>
                        </div>
                    </div>
                </div>

                <!-- Replies -->
                {% for reply in replies %}
                <div class="flex gap-3 {% if reply.is_admin %}flex-row-reverse{% endif %}">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-full {% if reply.is_admin %}bg-blue-500 text-white{% else %}bg-gray-200 dark:bg-zinc-700 text-gray-600 dark:text-gray-300{% endif %} flex items-center justify-center font-medium">
                            {{ reply.sender_name[0] if reply.sender_name }}
                        </div>
                    </div>
                    <div class="flex-1 {% if reply.is_admin %}text-right{% endif %}">
                        <div class="{% if reply.is_admin %}bg-blue-500 text-white{% else %}bg-gray-100 dark:bg-zinc-800 text-gray-700 dark:text-gray-300{% endif %} rounded-lg p-4 inline-block max-w-3xl text-left">
                            <div class="flex items-center justify-between mb-2">
                                <p class="text-sm font-medium {% if not reply.is_admin %}text-gray-900 dark:text-white{% endif %}">{{ reply.sender_name }}</p>
                                <p class="text-xs {% if reply.is_admin %}text-blue-100{% else %}text-gray-500 dark:text-gray-400{% endif %} ml-4">{{ reply.created_at.strftime('%d-%m-%Y %H:%M') }}</p>
                            </div>
                            <p>{{ reply.message }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Reply Form -->
            <div class="border-t border-gray-200 dark:border-zinc-800 pt-4">
                <form id="replyForm" class="flex gap-3">
                    <textarea id="replyMessage" rows="3" class="flex-1 px-4 py-2 border border-gray-300 dark:border-zinc-700 rounded-lg bg-white dark:bg-zinc-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 resize-none" placeholder="Typ je antwoord..."></textarea>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors h-fit">
                        Verstuur
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const ticketId = {{ ticket.id }};
        const statusDropdown = document.getElementById('statusDropdown');
        const replyForm = document.getElementById('replyForm');
        const replyMessage = document.getElementById('replyMessage');
        const messagesContainer = document.getElementById('messages');

        statusDropdown.addEventListener('change', async () => {
            const newStatus = statusDropdown.value;
            try {
                const response = await fetch(`/api/super-admin/support/${ticketId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    location.reload();
                } else {
                    alert('Fout bij updaten status');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Fout bij updaten status');
            }
        });

        replyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const message = replyMessage.value.trim();
            if (!message) return;

            try {
                const response = await fetch(`/api/super-admin/support/${ticketId}/reply`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    const replyHtml = `
                        <div class="flex gap-3 flex-row-reverse">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-medium">
                                    ${data.reply.sender_name[0]}
                                </div>
                            </div>
                            <div class="flex-1 text-right">
                                <div class="bg-blue-500 text-white rounded-lg p-4 inline-block max-w-3xl text-left">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-sm font-medium">${data.reply.sender_name}</p>
                                        <p class="text-xs text-blue-100 ml-4">${data.reply.created_at}</p>
                                    </div>
                                    <p>${data.reply.message}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    messagesContainer.insertAdjacentHTML('beforeend', replyHtml);
                    replyMessage.value = '';
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    statusDropdown.value = 'answered';
                } else {
                    alert('Fout bij versturen antwoord');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Fout bij versturen antwoord');
            }
        });
    </script>
</body>
</html>
